name: Daily Briefing

on:
  schedule:
    # Run at 08:00 Beijing time (00:00 UTC) - to read previous day's Obsidian sync
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  generate-briefing:
    runs-on: ubuntu-latest
    
    steps:
    - name: Get yesterday's date
      id: date
      run: |
        echo "yesterday=$(date -d 'yesterday' +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for Obsidian sync submodule
        
    - name: Checkout Obsidian Sync
      env:
        OBSIDIAN_TOKEN: ${{ secrets.OBSIDIAN_TOKEN }}
      run: |
        git clone https://zhongyi-byte:${OBSIDIAN_TOKEN}@github.com/zhongyi-byte/obsidian-sync.git ../obsidian-sync
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests pyyaml jinja2
        
    - name: Generate briefing for previous day
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Generate briefing for previous day (yesterday)
        python scripts/generate_briefing.py --date yesterday
        
    - name: Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        # Use yesterday's date in commit message
        YESTERDAY=$(date -d "yesterday" +%Y-%m-%d)
        git commit -m "Add briefing for $YESTERDAY" || exit 0
        git push
        
    # Per requirement: deploy Pages artifacts to dedicated `master` branch (orphaned to avoid touching source)
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: master
        publish_dir: ./docs
        force_orphan: true
        
    - name: Send Telegram Notification
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          ğŸ“‹ ä¸ªäººç”Ÿæ´»ç®€æŠ¥å·²ç”Ÿæˆ
          
          æ—¥æœŸ: ${{ steps.date.outputs.yesterday }}
          
          ğŸ“Š æŸ¥çœ‹ä»ªè¡¨ç›˜: https://zhongyi-byte.github.io/life-briefing/
          ğŸ“„ æŸ¥çœ‹ç®€æŠ¥: https://github.com/zhongyi-byte/life-briefing/tree/main/briefings
          
          è®°å¾—è®°å½•ä»Šå¤©çš„ç¡çœ å’Œè¿åŠ¨æ•°æ®å“¦ï¼
